<!DOCTYPE html>
<html lang="zh-CN" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>è€å¹´æ™ºèƒ½æ‰‹ç¯åŠ©æ‰‹</title>
    <style>
        /* ä¼˜åŒ–è®¾ç½®ç•Œé¢æ ·å¼ */
        .settings-form {
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin: 25px auto;
            max-width: 550px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-size: 20px;
            margin-bottom: 10px;
            color: #2c3e50;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #bdc3c7;
            border-radius: 10px;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            border-color: #3498db;
            outline: none;
        }

        .save-btn {
            background: #2ecc71;
            font-size: 20px;
            padding: 20px;
            margin-top: 30px;
            transition: background 0.3s ease;
        }

        .save-btn:hover {
            background: #27ae60;
        }

        /* æ–°å¢è¾“å…¥æç¤ºæ ·å¼ */
        .input-hint {
            color: #7f8c8d;
            font-size: 14px;
            margin-top: 5px;
            display: block;
        }

        /* é”™è¯¯æç¤ºæ ·å¼ */
        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¸»èœå•ä¿æŒä¸å˜ -->

        <!-- ä¼˜åŒ–åçš„è®¾ç½®ç•Œé¢ -->
        <section id="settings" class="hidden">
            <h1 aria-label="ç³»ç»Ÿè®¾ç½®">âš™ï¸ ç³»ç»Ÿè®¾ç½®</h1>
            <div class="settings-form">
                <div class="form-group">
                    <label>äº²å±ç”µè¯å·ç ï¼š</label>
                    <input type="tel" id="family-number" class="form-input" 
                           placeholder="ä¾‹å¦‚ï¼š13800138000" pattern="[0-9-]+">
                    <span class="input-hint">è¯·è¾“å…¥11ä½æ‰‹æœºå·ç æˆ–å¸¦åŒºå·çš„åº§æœº</span>
                    <div class="error-message" id="family-error"></div>
                </div>

                <div class="form-group">
                    <label>ç¤¾åŒºåŒ»ç”Ÿç”µè¯ï¼š</label>
                    <input type="tel" id="doctor-number" class="form-input"
                           placeholder="ä¾‹å¦‚ï¼š13900139000" pattern="[0-9-]+">
                    <span class="input-hint">åŒ»ç”Ÿå€¼ç­ç”µè¯æˆ–ç´§æ€¥è”ç³»å·ç </span>
                    <div class="error-message" id="doctor-error"></div>
                </div>

                <div class="form-group">
                    <label>ç‰©ä¸šè”ç³»ç”µè¯ï¼š</label>
                    <input type="tel" id="property-number" class="form-input"
                           placeholder="ä¾‹å¦‚ï¼š010-12345678" pattern="[0-9-]+">
                    <span class="input-hint">è¯·åŒ…å«åŒºå·ï¼Œç”¨çŸ­æ¨ªçº¿åˆ†éš”</span>
                    <div class="error-message" id="property-error"></div>
                </div>

                <div class="form-group">
                    <label>åŸºç¡€ç–¾ç—…ï¼š</label>
                    <input type="text" id="medical-conditions" class="form-input"
                           placeholder="ä¾‹å¦‚ï¼šé«˜è¡€å‹, ç³–å°¿ç—…">
                    <span class="input-hint">å¤šä¸ªç–¾ç—…è¯·ç”¨é€—å·åˆ†éš”</span>
                    <div class="error-message" id="conditions-error"></div>
                </div>

                <div class="form-group">
                    <label>è¿‡æ•å²ï¼š</label>
                    <input type="text" id="medical-allergies" class="form-input"
                           placeholder="ä¾‹å¦‚ï¼šé’éœ‰ç´ , èŠ±ç²‰">
                    <span class="input-hint">å¤šä¸ªè¿‡æ•æºè¯·ç”¨é€—å·åˆ†éš”</span>
                    <div class="error-message" id="allergies-error"></div>
                </div>

                <div class="form-group">
                    <label>ç´§æ€¥è”ç³»äººï¼š</label>
                    <input type="text" id="emergency-contact" class="form-input"
                           placeholder="æ ¼å¼ï¼šå§“å ç”µè¯">
                    <span class="input-hint">ç¤ºä¾‹ï¼šå¼ åŒ»ç”Ÿ 13800138000</span>
                    <div class="error-message" id="contact-error"></div>
                </div>

                <button class="menu-btn save-btn" onclick="saveSettings()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
                <button class="menu-btn back-btn" onclick="backToMenu()">â† è¿”å›ä¸»èœå•</button>
            </div>
        </section>
    </div>

    <script>
        // ================== ä¼˜åŒ–è®¾ç½®åŠŸèƒ½ ==================
        function showError(fieldId, message) {
            const errorElement = document.getElementById(fieldId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => errorElement.style.display = 'none', 3000);
        }

        function validateContact(contact) {
            const pattern = /^[\u4e00-\u9fa5]{2,4}\s+1[3-9]\d{9}$/;
            return pattern.test(contact);
        }

        function saveSettings() {
            // æ¸…é™¤æ—§é”™è¯¯æç¤º
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');

            // ç”µè¯å·ç éªŒè¯
            const phoneFields = {
                family: document.getElementById('family-number'),
                doctor: document.getElementById('doctor-number'),
                property: document.getElementById('property-number')
            };

            const newNumbers = {};
            let isValid = true;
            const phoneRegex = /^(?:\+?86)?(?:1[3-9]\d{9}|0\d{2,3}-?\d{7,8})$/;

            for (const [key, input] of Object.entries(phoneFields)) {
                const value = input.value.trim();
                if (!phoneRegex.test(value)) {
                    showError(`${key}-error`, `è¯·è¾“å…¥æœ‰æ•ˆçš„${getChineseName(key)}å·ç `);
                    isValid = false;
                }
                newNumbers[key] = value;
            }

            // åŒ»ç–—ä¿¡æ¯éªŒè¯
            const medicalData = {
                conditions: document.getElementById('medical-conditions').value,
                allergies: document.getElementById('medical-allergies').value,
                contact: document.getElementById('emergency-contact').value
            };

            const newMedical = {
                conditions: medicalData.conditions.split(',').map(s => s.trim()).filter(s => s),
                allergies: medicalData.allergies.split(',').map(s => s.trim()).filter(s => s),
                emergencyContact: medicalData.contact.trim()
            };

            if (newMedical.conditions.length === 0) {
                showError('conditions-error', 'è‡³å°‘éœ€è¦å¡«å†™ä¸€é¡¹åŸºç¡€ç–¾ç—…');
                isValid = false;
            }

            if (newMedical.allergies.length === 0) {
                newMedical.allergies = ["æ— "]; // é»˜è®¤å€¼
            }

            if (!validateContact(newMedical.emergencyContact)) {
                showError('contact-error', 'æ ¼å¼ï¼šå§“å + ç©ºæ ¼ + 11ä½æ‰‹æœºå·');
                isValid = false;
            }

            if (!isValid) return;

            // ä¿å­˜æ•°æ®
            localStorage.setItem('phoneSettings', JSON.stringify(newNumbers));
            localStorage.setItem('medicalInfo', JSON.stringify(newMedical));
            
            // æ›´æ–°åº”ç”¨çŠ¶æ€
            Object.assign(phoneNumbers, newNumbers);
            medicalInfo = newMedical;
            
            // ç•Œé¢æ›´æ–°
            updateMedicalDisplay();
            initCallSections();
            
            // ä¿å­˜æˆåŠŸæç¤º
            const successAlert = document.createElement('div');
            successAlert.textContent = 'âœ“ è®¾ç½®ä¿å­˜æˆåŠŸï¼';
            successAlert.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #2ecc71;
                color: white;
                padding: 15px 30px;
                border-radius: 25px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 1000;
            `;
            document.body.appendChild(successAlert);
            setTimeout(() => successAlert.remove(), 2000);

            backToMenu();
        }

        // å…¶ä»–ä¿æŒåŸæœ‰ä¼˜åŒ–...
    </script>
</body>
</html>
