<!DOCTYPE html>
<html lang="zh-CN" translate="no">
<head>现在给这个代码新添一个设置功能，设置功能在最下面。在点进设置后，用户可以修改“呼叫亲属”“社区医生”、“物业联系”的电话号码，以及“我的基础病”信息。修改好后，将它插入进之前的代码把整个新代码发给我
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>老年智能手环助手</title>
    <style>
        :root {
            --primary-color: #E74C3C;
            --secondary-color: #3498DB;
            --text-size: 24px;
        }

        body {
            font-family: "微软雅黑", Arial, sans-serif;
            background: #F8F9FA;
            margin: 0;
            padding: 20px;
        }

        .menu-btn {
            display: block;
            width: 90%;
            margin: 15px auto;
            padding: 25px;
            font-size: var(--text-size);
            border-radius: 15px;
            border: none;
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .back-btn {
            background: #7F8C8D;
            width: 50%;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .hidden {
            display: none;
        }

        #ai-input {
            width: 80%;
            padding: 15px;
            font-size: 20px;
            margin: 20px 0;
        }

        #medical-info {
            background: #FFF3CD;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border: 1px solid #FFE699;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 主菜单 -->
        <section id="main-menu">
            <button class="menu-btn" onclick="showSection('emergency')">紧急求救</button>
            <button class="menu-btn" onclick="showSection('family')">呼叫亲属</button>
            <button class="menu-btn" onclick="showSection('doctor')">社区医生</button>
            <button class="menu-btn" onclick="showSection('property')">物业联系</button>
            <button class="menu-btn" onclick="showSection('ai-chat')">万能问答</button>
            <button class="menu-btn" onclick="showSection('medical')">我的基础病</button>
        </section>

        <!-- 紧急呼叫界面 -->
        <section id="emergency" class="hidden">
            <h1 aria-label="紧急求救">🆘 正在呼叫急救中心</h1>
            <button class="menu-btn" onclick="callNumber('120')">立即拨打120</button>
            <button class="menu-btn back-btn" onclick="backToMenu()">← 返回主菜单</button>
        </section>

        <!-- 其他呼叫界面模板 -->
        <template id="call-template">
            <h1></h1>
            <button class="menu-btn"></button>
            <button class="menu-btn back-btn">← 返回主菜单</button>
        </template>

        <!-- AI问答界面 -->
        <section id="ai-chat" class="hidden">
            <h1 aria-label="智能问答">❓ 万能问答助手</h1>
            <input type="text" id="ai-input" placeholder="请输入您的问题...">
            <button class="menu-btn" onclick="getAIResponse()">提交问题</button>
            <div id="ai-response" style="padding:20px;font-size:var(--text-size)"></div>
            <button class="menu-btn back-btn" onclick="backToMenu()">← 返回主菜单</button>
        </section>

        <!-- 基础病信息界面 -->
        <section id="medical" class="hidden">
            <h1 aria-label="基础病信息">📋 我的健康档案</h1>
            <div id="medical-info">
                <p>加载中...</p>
            </div>
            <button class="menu-btn" onclick="editMedicalInfo()">修改信息</button>
            <button class="menu-btn back-btn" onclick="backToMenu()">← 返回主菜单</button>
        </section>
    </div>

    <script>
        // 电话号码配置
        const phoneNumbers = {
            family: '13800138000',
            doctor: '13900139000',
            property: '010-12345678'
        }

        // 初始化医疗信息
        let medicalInfo = JSON.parse(localStorage.getItem('medicalInfo')) || {
            conditions: ["高血压", "糖尿病"],
            allergies: ["青霉素"],
            emergencyContact: "张医生 13800138000"
        }

        // 界面切换控制（添加防护性检查）
        function showSection(sectionId) {
            const sections = document.querySelectorAll('section');
            if (!sections) return;
            
            sections.forEach(s => {
                if (s.classList) s.classList.add('hidden');
            });

            const targetSection = document.getElementById(sectionId);
            if (targetSection && targetSection.classList) {
                targetSection.classList.remove('hidden');
                if(sectionId === 'medical') updateMedicalDisplay();
            }
        }

        function backToMenu() {
            showSection('main-menu');
        }

        // 增强版拨号功能
        function callNumber(number) {
            const phoneRegex = /^(?:\+?86)?(?:1[3-9]\d{9}|0\d{2,3}-?\d{7,8})$/;
            
            if (!phoneRegex.test(number)) {
                alert("请输入有效的电话号码\n示例：13800138000 或 010-12345678");
                speak("号码格式错误");
                return;
            }

            if (window.confirm(`确认要拨打 ${number} 吗？`)) {
                speak(`正在拨打${number}`);
                window.location.href = `tel:${number}`;
            }
        }

        // 语音提示（添加容错机制）
        function speak(text) {
            try {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'zh-CN';
                    window.speechSynthesis.speak(utterance);
                }
            } catch (e) {
                console.log('语音功能不可用:', e);
            }
        }

        // 优化后的AI问答功能
        async function getAIResponse() {
            const question = document.getElementById('ai-input').value.trim();
            const responseBox = document.getElementById('ai-response');
            
            if (!question) {
                alert("请输入您的问题");
                return;
            }

            responseBox.innerHTML = '<div class="loading">思考中...</div>';
            
            try {
                const response = await simulateAIResponse(question);
                responseBox.innerHTML = response;
                speak("已收到回答");
            } catch (error) {
                responseBox.innerHTML = '服务暂时不可用，请稍后重试';
                speak("网络连接失败");
            }
        }

        // 医疗信息管理（优化输入方式）
        function editMedicalInfo() {
            const conditions = prompt("现有疾病（用逗号分隔）:", medicalInfo.conditions.join(","));
            const allergies = prompt("过敏药物（用逗号分隔）:", medicalInfo.allergies.join(","));
            const contact = prompt("紧急联系人及电话:", medicalInfo.emergencyContact);

            if (conditions && allergies && contact) {
                medicalInfo = {
                    conditions: conditions.split(",").map(s => s.trim()),
                    allergies: allergies.split(",").map(s => s.trim()),
                    emergencyContact: contact
                };
                localStorage.setItem('medicalInfo', JSON.stringify(medicalInfo));
                updateMedicalDisplay();
            }
        }

        // 初始化动态呼叫界面（修复版）
        function initCallSections() {
            const template = document.getElementById('call-template');
            if (!template) return;

            ['family', 'doctor', 'property'].forEach(type => {
                const section = document.createElement('section');
                section.className = 'hidden';
                section.id = type;
                
                const clone = document.importNode(template.content, true);
                const title = clone.querySelector('h1');
                const button = clone.querySelector('.menu-btn');
                const backBtn = clone.querySelector('.back-btn');

                if (title && button && backBtn) {
                    title.textContent = `📞 正在呼叫${getTitle(type)}`;
                    button.textContent = `拨打 ${phoneNumbers[type]}`;
                    button.onclick = () => callNumber(phoneNumbers[type]);
                    backBtn.onclick = backToMenu;
                    section.appendChild(clone);
                    document.querySelector('.container').appendChild(section);
                }
            });
        }

        function getTitle(type) {
            return {
                family: '亲属',
                doctor: '社区医生',
                property: '物业服务'
            }[type];
        }

        // 初始化执行
        document.addEventListener('DOMContentLoaded', () => {
            initCallSections();
            speak("欢迎使用智能手环助手");
        });
    </script>
</body>
</html>
