<!DOCTYPE html>
<html lang="zh-CN" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>è€å¹´æ™ºèƒ½æ‰‹ç¯åŠ©æ‰‹</title>
    <style>
        /* æ–°å¢è®¾ç½®ç•Œé¢æ ·å¼ */
        .settings-form {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 20px auto;
            max-width: 500px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-size: 18px;
            margin-bottom: 8px;
            color: #333;
        }
        .form-input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
        }
        .save-btn {
            background: #27ae60;
            width: 100%;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¿®æ”¹ä¸»èœå•æ–°å¢è®¾ç½®æŒ‰é’® -->
        <section id="main-menu">
            <button class="menu-btn" onclick="showSection('emergency')">ç´§æ€¥æ±‚æ•‘</button>
            <button class="menu-btn" onclick="showSection('family')">å‘¼å«äº²å±</button>
            <button class="menu-btn" onclick="showSection('doctor')">ç¤¾åŒºåŒ»ç”Ÿ</button>
            <button class="menu-btn" onclick="showSection('property')">ç‰©ä¸šè”ç³»</button>
            <button class="menu-btn" onclick="showSection('ai-chat')">ä¸‡èƒ½é—®ç­”</button>
            <button class="menu-btn" onclick="showSection('medical')">æˆ‘çš„åŸºç¡€ç—…</button>
            <button class="menu-btn" onclick="showSection('settings')">âš™ï¸ ç³»ç»Ÿè®¾ç½®</button>
        </section>

        <!-- æ–°å¢è®¾ç½®ç•Œé¢ï¼ˆä½äºæ‰€æœ‰ç•Œé¢ä¹‹åï¼‰ -->
        <section id="settings" class="hidden">
            <h1 aria-label="ç³»ç»Ÿè®¾ç½®">âš™ï¸ ç³»ç»Ÿè®¾ç½®</h1>
            <div class="settings-form">
                <div class="form-group">
                    <label>äº²å±ç”µè¯å·ç ï¼š</label>
                    <input type="tel" id="family-number" class="form-input" 
                           placeholder="ä¾‹å¦‚ï¼š13800138000" pattern="[0-9-]+">
                </div>
                <div class="form-group">
                    <label>ç¤¾åŒºåŒ»ç”Ÿç”µè¯ï¼š</label>
                    <input type="tel" id="doctor-number" class="form-input"
                           placeholder="ä¾‹å¦‚ï¼š13900139000" pattern="[0-9-]+">
                </div>
                <div class="form-group">
                    <label>ç‰©ä¸šè”ç³»ç”µè¯ï¼š</label>
                    <input type="tel" id="property-number" class="form-input"
                           placeholder="ä¾‹å¦‚ï¼š010-12345678" pattern="[0-9-]+">
                </div>
                <div class="form-group">
                    <label>åŸºç¡€ç–¾ç—…ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰ï¼š</label>
                    <input type="text" id="medical-conditions" class="form-input"
                           placeholder="ä¾‹å¦‚ï¼šé«˜è¡€å‹,ç³–å°¿ç—…">
                </div>
                <div class="form-group">
                    <label>è¿‡æ•å²ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰ï¼š</label>
                    <input type="text" id="medical-allergies" class="form-input"
                           placeholder="ä¾‹å¦‚ï¼šé’éœ‰ç´ ,èŠ±ç²‰">
                </div>
                <div class="form-group">
                    <label>ç´§æ€¥è”ç³»äººï¼š</label>
                    <input type="text" id="emergency-contact" class="form-input"
                           placeholder="æ ¼å¼ï¼šå¼ åŒ»ç”Ÿ 13800138000">
                </div>

                <button class="menu-btn save-btn" onclick="saveSettings()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
                <button class="menu-btn back-btn" onclick="backToMenu()">â† è¿”å›ä¸»èœå•</button>
            </div>
        </section>

        <!-- åŸæœ‰å…¶ä»–ç•Œé¢ä¿æŒä¸å˜ -->
    </div>

    <script>
        // ================== æ–°å¢è®¾ç½®åŠŸèƒ½ ==================
        function loadSettings() {
            // åŠ è½½ç”µè¯å·ç è®¾ç½®
            const savedNumbers = JSON.parse(localStorage.getItem('phoneSettings')) || {};
            phoneNumbers.family = savedNumbers.family || '13800138000';
            phoneNumbers.doctor = savedNumbers.doctor || '13900139000';
            phoneNumbers.property = savedNumbers.property || '010-12345678';

            // åŠ è½½åŒ»ç–—ä¿¡æ¯
            const savedMedical = JSON.parse(localStorage.getItem('medicalInfo')) || {
                conditions: ["é«˜è¡€å‹", "ç³–å°¿ç—…"],
                allergies: ["é’éœ‰ç´ "],
                emergencyContact: "å¼ åŒ»ç”Ÿ 13800138000"
            };
            medicalInfo = savedMedical;

            // å¡«å……è®¾ç½®è¡¨å•
            document.getElementById('family-number').value = phoneNumbers.family;
            document.getElementById('doctor-number').value = phoneNumbers.doctor;
            document.getElementById('property-number').value = phoneNumbers.property;
            document.getElementById('medical-conditions').value = medicalInfo.conditions.join(",");
            document.getElementById('medical-allergies').value = medicalInfo.allergies.join(",");
            document.getElementById('emergency-contact').value = medicalInfo.emergencyContact;
        }

        function saveSettings() {
            // éªŒè¯å¹¶ä¿å­˜ç”µè¯å·ç 
            const newNumbers = {
                family: document.getElementById('family-number').value.trim(),
                doctor: document.getElementById('doctor-number').value.trim(),
                property: document.getElementById('property-number').value.trim()
            };

            const phoneRegex = /^(?:\+?86)?(?:1[3-9]\d{9}|0\d{2,3}-?\d{7,8})$/;
            for (const key in newNumbers) {
                if (!phoneRegex.test(newNumbers[key])) {
                    alert(`è¯·è¾“å…¥æœ‰æ•ˆçš„${getChineseName(key)}å·ç `);
                    return;
                }
            }

            // éªŒè¯å¹¶ä¿å­˜åŒ»ç–—ä¿¡æ¯
            const newMedical = {
                conditions: document.getElementById('medical-conditions').value.split(',').map(s => s.trim()),
                allergies: document.getElementById('medical-allergies').value.split(',').map(s => s.trim()),
                emergencyContact: document.getElementById('emergency-contact').value.trim()
            };

            if (newMedical.conditions.some(c => !c) || 
                newMedical.allergies.some(a => !a) || 
                !newMedical.emergencyContact) {
                alert("è¯·å¡«å†™å®Œæ•´çš„å¥åº·ä¿¡æ¯");
                return;
            }

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('phoneSettings', JSON.stringify(newNumbers));
            localStorage.setItem('medicalInfo', JSON.stringify(newMedical));
            
            // æ›´æ–°è¿è¡Œæ—¶æ•°æ®
            Object.assign(phoneNumbers, newNumbers);
            medicalInfo = newMedical;
            
            // æ›´æ–°ç•Œé¢æ˜¾ç¤º
            updateMedicalDisplay();
            initCallSections(); // é‡æ–°åˆå§‹åŒ–å‘¼å«æŒ‰é’®
            alert("è®¾ç½®å·²ä¿å­˜ï¼");
            backToMenu();
        }

        function getChineseName(key) {
            return {
                family: 'äº²å±',
                doctor: 'ç¤¾åŒºåŒ»ç”Ÿ',
                property: 'ç‰©ä¸š'
            }[key];
        }

        // åˆå§‹åŒ–æ—¶åŠ è½½è®¾ç½®
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            initCallSections();
            speak("æ¬¢è¿ä½¿ç”¨æ™ºèƒ½æ‰‹ç¯åŠ©æ‰‹");
        });
        // ================== è®¾ç½®åŠŸèƒ½ç»“æŸ ==================
    </script>
</body>
</html>
