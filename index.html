<!DOCTYPE html>
<html lang="zh-CN" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>老年智能手环助手</title>
    <style>
        /* 优化设置界面样式 */
        .settings-form {
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin: 25px auto;
            max-width: 550px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-size: 20px;
            margin-bottom: 10px;
            color: #2c3e50;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #bdc3c7;
            border-radius: 10px;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            border-color: #3498db;
            outline: none;
        }

        .save-btn {
            background: #2ecc71;
            font-size: 20px;
            padding: 20px;
            margin-top: 30px;
            transition: background 0.3s ease;
        }

        .save-btn:hover {
            background: #27ae60;
        }

        /* 新增输入提示样式 */
        .input-hint {
            color: #7f8c8d;
            font-size: 14px;
            margin-top: 5px;
            display: block;
        }

        /* 错误提示样式 */
        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 主菜单保持不变 -->

        <!-- 优化后的设置界面 -->
        <section id="settings" class="hidden">
            <h1 aria-label="系统设置">⚙️ 系统设置</h1>
            <div class="settings-form">
                <div class="form-group">
                    <label>亲属电话号码：</label>
                    <input type="tel" id="family-number" class="form-input" 
                           placeholder="例如：13800138000" pattern="[0-9-]+">
                    <span class="input-hint">请输入11位手机号码或带区号的座机</span>
                    <div class="error-message" id="family-error"></div>
                </div>

                <div class="form-group">
                    <label>社区医生电话：</label>
                    <input type="tel" id="doctor-number" class="form-input"
                           placeholder="例如：13900139000" pattern="[0-9-]+">
                    <span class="input-hint">医生值班电话或紧急联系号码</span>
                    <div class="error-message" id="doctor-error"></div>
                </div>

                <div class="form-group">
                    <label>物业联系电话：</label>
                    <input type="tel" id="property-number" class="form-input"
                           placeholder="例如：010-12345678" pattern="[0-9-]+">
                    <span class="input-hint">请包含区号，用短横线分隔</span>
                    <div class="error-message" id="property-error"></div>
                </div>

                <div class="form-group">
                    <label>基础疾病：</label>
                    <input type="text" id="medical-conditions" class="form-input"
                           placeholder="例如：高血压, 糖尿病">
                    <span class="input-hint">多个疾病请用逗号分隔</span>
                    <div class="error-message" id="conditions-error"></div>
                </div>

                <div class="form-group">
                    <label>过敏史：</label>
                    <input type="text" id="medical-allergies" class="form-input"
                           placeholder="例如：青霉素, 花粉">
                    <span class="input-hint">多个过敏源请用逗号分隔</span>
                    <div class="error-message" id="allergies-error"></div>
                </div>

                <div class="form-group">
                    <label>紧急联系人：</label>
                    <input type="text" id="emergency-contact" class="form-input"
                           placeholder="格式：姓名 电话">
                    <span class="input-hint">示例：张医生 13800138000</span>
                    <div class="error-message" id="contact-error"></div>
                </div>

                <button class="menu-btn save-btn" onclick="saveSettings()">💾 保存设置</button>
                <button class="menu-btn back-btn" onclick="backToMenu()">← 返回主菜单</button>
            </div>
        </section>
    </div>

    <script>
        // ================== 优化设置功能 ==================
        function showError(fieldId, message) {
            const errorElement = document.getElementById(fieldId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => errorElement.style.display = 'none', 3000);
        }

        function validateContact(contact) {
            const pattern = /^[\u4e00-\u9fa5]{2,4}\s+1[3-9]\d{9}$/;
            return pattern.test(contact);
        }

        function saveSettings() {
            // 清除旧错误提示
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');

            // 电话号码验证
            const phoneFields = {
                family: document.getElementById('family-number'),
                doctor: document.getElementById('doctor-number'),
                property: document.getElementById('property-number')
            };

            const newNumbers = {};
            let isValid = true;
            const phoneRegex = /^(?:\+?86)?(?:1[3-9]\d{9}|0\d{2,3}-?\d{7,8})$/;

            for (const [key, input] of Object.entries(phoneFields)) {
                const value = input.value.trim();
                if (!phoneRegex.test(value)) {
                    showError(`${key}-error`, `请输入有效的${getChineseName(key)}号码`);
                    isValid = false;
                }
                newNumbers[key] = value;
            }

            // 医疗信息验证
            const medicalData = {
                conditions: document.getElementById('medical-conditions').value,
                allergies: document.getElementById('medical-allergies').value,
                contact: document.getElementById('emergency-contact').value
            };

            const newMedical = {
                conditions: medicalData.conditions.split(',').map(s => s.trim()).filter(s => s),
                allergies: medicalData.allergies.split(',').map(s => s.trim()).filter(s => s),
                emergencyContact: medicalData.contact.trim()
            };

            if (newMedical.conditions.length === 0) {
                showError('conditions-error', '至少需要填写一项基础疾病');
                isValid = false;
            }

            if (newMedical.allergies.length === 0) {
                newMedical.allergies = ["无"]; // 默认值
            }

            if (!validateContact(newMedical.emergencyContact)) {
                showError('contact-error', '格式：姓名 + 空格 + 11位手机号');
                isValid = false;
            }

            if (!isValid) return;

            // 保存数据
            localStorage.setItem('phoneSettings', JSON.stringify(newNumbers));
            localStorage.setItem('medicalInfo', JSON.stringify(newMedical));
            
            // 更新应用状态
            Object.assign(phoneNumbers, newNumbers);
            medicalInfo = newMedical;
            
            // 界面更新
            updateMedicalDisplay();
            initCallSections();
            
            // 保存成功提示
            const successAlert = document.createElement('div');
            successAlert.textContent = '✓ 设置保存成功！';
            successAlert.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #2ecc71;
                color: white;
                padding: 15px 30px;
                border-radius: 25px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 1000;
            `;
            document.body.appendChild(successAlert);
            setTimeout(() => successAlert.remove(), 2000);

            backToMenu();
        }

        // 其他保持原有优化...
    </script>
</body>
</html>
